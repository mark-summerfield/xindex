#!/usr/bin/env python3
# Copyright © 2015-20 Qtrac Ltd. All rights reserved.

import os
import sys
sys.path.insert(0, os.path.join(os.path.dirname(__file__), ".."))
import unittest

import Pages


class TestPages(unittest.TestCase):

    def setUp(self):
        self.maxDiff = None


    def do_test(self, pairs, *, checkOverpapping=False):
        for i, (original, expected) in enumerate(pairs):
            original = Pages.sortedPages(original)
            expected = Pages.sortedPages(expected)
            with self.subTest(i=i):
                actual = Pages.combinedOverlappingPages(original)
                if actual != expected:
                    print()
                    print("O", original)
                    print("X", expected)
                    print("A", actual)
                self.assertEqual(actual, expected)
                if checkOverpapping:
                    self.assertTrue(Pages.hasOverlappingPages(original) ==
                                    (original != actual))


    def test_combinePages0(self):
        self.do_test(PAGESPAIRS0, checkOverpapping=True)


    def test_combinePages1(self):
        self.do_test(PAGESPAIRS1)


    def test_combinePages2(self):
        self.do_test(PAGESPAIRS2)


    def test_combinePages4(self):
        self.do_test(PAGESPAIRS4, checkOverpapping=True)



PAGESPAIRS0 = (
    ("360-365, 361, 362, 364-366", "360-366"),
    ("402, 411, 411-17, 419, 431", "402, 411-17, 419, 431"),
    ("""402, <span style="font-size: \
11pt; font-family: 'courier';">411</span>, 411–17, <span \
style="font-size: 11pt; font-family: 'courier';">419</span>, 431""",
     """402, 411–17, <span \
style="font-size: 11pt; font-family: 'courier';">419</span>, 431"""),
    ("37, 45, 45–50", "37, 45–50"),
    ("11, 21–25, 22", "11, 21–25"),
    ("11, 21–25, 22t", "11, 21–25"),
    ("380–88, <b>382–89</b>", "380–89"),
    ("2–11, 41–46, 97, 123, 262, 265f, 380–88, 382–89, 390–92, 479, 489–94",
     "2–11, 41–46, 97, 123, 262, 265f, 380–89, 390–92, 479, 489–94"),
    ("15, 37, 211, 223–26, 359, 372, 372, 386, 396, 448–54, 484",
     "15, 37, 211, 223–26, 359, 372, 386, 396, 448–54, 484"),
    ("94, 163–69, 164, 180, 190, 238–47, 260, 262, 316–20, 372–79, 429t",
     "94, 163–69, 180, 190, 238–47, 260, 262, 316–20, 372–79, 429t"),
    ("1–6, 5, 9–11, 10tbl, 15, 15–19, 26fig, 26–28",
     "1–6, 9–11, 15–19, 26–28"),
    )

PAGESPAIRS1 = (
    ("""89, 32, 4, xii, 492, vi, 12, xiv, 49, 32, vi, 89, 18(nn 12, 15)""",
        """vi, xii, xiv, 4, 12, 18(nn 12, 15), 32, 49, 89, 492"""),
    ("""<b>719, 34, 11t</b>, ix, 42, <i>iv, 13f, 88</i>, 39, 4, ix, 42""",
        """<i>iv</i>, ix, 4, <b>11t</b>, <i>13f</i>, \
<b>34</b>, 39, 42, <i>88</i>, <b>719</b>"""),
    ("""85, <b>35</b>(nn. 11, 19), 75<sub>2</sub>, \
<i>81<sup>a</sup></i>, 49""",
        """<b>35</b>(nn. 11, 19), 49, 75<sub>2</sub>, \
<i>81</i><sup><i>a</i></sup>, 85"""),
    ("101–8, 101, 106, 809, 1104, <b>808</b>–33, <i>1103–</i>4, \
1206(nn. <b>83</b>, 91)",
        "101–108, <b>808</b>–833, <i>1103</i>–1104, 1206(nn. <b>83</b>, \
91)"),
    ("240\u2013248, 243\u2013245, 237\u2013241, 247\u2013252",
        "237\u2013252"),
    ("""<i>281f</i>, <i><span style="font-size: 11pt;
font-family: 'times new roman';">240 - 248 </span></i>, 116- 118, xv,
 <i><span style="font-size: 11pt;
font-family: 'times new roman';">243 - 245 </span></i>,
 <i><span style="font-size: 11pt;
font-family: 'times new roman';">237 - 241 </span></i>,
 <i><span style="font-size: 11pt;
font-family: 'times new roman';">247 - 252 </span></i>,
<b>32t</b>, 24""",
        """xv, 24, <b>32t</b>, 116\u2013118, \
<i><span style="font-size: 11pt; font-family: 'times new roman';">237\
</span></i><i>\u2013</i>\
<i><span style="font-size: 11pt; font-family: 'times new roman';">252\
</span></i>, <i>281f</i>"""),
    ("102–9, <b>908</b>–33, , <b>910</b>–34, 2103–<i>4</i>, 2104-2106",
        "102–109, <b>908</b>–934, 2103–<i>2106</i>"),
    ("321–28, 498–532, 1087–89, 1496–500, 500, 531-533, 11564–615, \
12991–3001",
        "321–328, 498–533, 1087–1089, 1496–1500, 11564–11615, 12991–13001"),
    ("""89, 32, 4, xii, 492, vi, 12, <b>xiv-</b>xvii, 49, xv-xvi, \
xvi-xviii, vi, 89""",
        """vi, xii, <b>xiv</b>\u2013xviii, 4, 12, 32, 49, 89, 492"""),
    ("""<b>719, 34, 11t</b>, ix, 42, <i>iv, 13f, 88</i>, 39, 4""",
        """<i>iv</i>, ix, 4, <b>11t</b>, <i>13f</i>,
<b>34</b>, 39, 42, <i>88</i>, <b>719</b>"""),
    ("""85, <b>35</b>, 75<sub>2</sub>, <i>81<sup>a</sup></i>,
49""",
        """<b>35</b>, 49, 75<sub>2</sub>,
<i>81</i><sup><i>a</i></sup>, 85"""),
    ("""<i>281f</i>, <i><span style="font-size: 11pt;
font-family: 'times new roman';">240 - 248 </span></i>, 116- 118, xv,
<b>32t</b>, 24""",
        """xv, 24, <b>32t</b>, 116\u2013118, \
<i><span style="font-size: 11pt; font-family: 'times new roman';">240\
</span></i><i>\u2013</i>\
<i><span style="font-size: 11pt; font-family: 'times new roman';">248\
</span></i>, <i>281f</i>"""),
    ("""<i>203,</i> 290-293, <i>177-182,</i> <span
style="font-size: 11pt; font-family: 'arial';"><i>105,</i></span>
<i>343 - 350,</i> <i><b>239</b>,</i> 154, <span style="font-size: 11pt;
font-family: 'arial';">100,</span> 110, 63, <b>482</b>""",
        """63, <span style="font-size: 11pt; font-family:
'arial';">100</span>, <i><span style="font-size: 11pt; font-family:
'arial';">105</span></i>, 110, 154, <i>177</i><i>\u2013</i><i>182</i>, \
<i>203</i>, <i><b>239</b></i>, 290\u2013293, \
<i>343</i><i>\u2013</i><i>350</i>, \
<b>482</b>"""),
    ("""420, 51<b>t</b>, <i>91<b>f,</b></i> 47\u2013<i>52,</i> 98,
420, 51<b>t</b>, <i>91<b>f</b>,</i> 47\u2013<i>52</i>, 98,
<b>82-<i>84</i></b>""",
        """47\u2013<i>52</i>, 51<b>t</b>, \
<b>82</b><b>\u2013</b><i><b>84</b></i>, <i>91</i><i><b>f</b></i>, 98, \
420"""),
    ("""<b>117</b>, 420, 51<b>t</b>, <i>91<b>f</b></i>,
47-<i>52</i>, <b>62-</b><b><i>64</i></b>, 63, 64-66, 98, <i>2</i>""",
        """<i>2</i>, 47\u2013<i>52</i>, 51<b>t</b>, \
<b>62</b><b>\u2013</b><i><b>66</b></i>, <i>91</i><i><b>f</b></i>, 98, \
<b>117</b>, 420"""),
    ("""7, 12, 78, 81<i>f</i>, 92-96, 203<b>t</b>, 206, 255,
290, 300t, 381, 482, 491, iv, xviii, <b>75c</b>""",
        """iv, xviii, 7, 12, <b>75c</b>, 78, 81<i>f</i>, 92\u201396,
203<b>t</b>, 206, 255, 290, 300t, 381, 482, 491""",),
    ("83, 56 to 74, 91, Frontispiece@0.1, 21-25 <i>passim</i>, 31",
        "Frontispiece@0.1, 21\u201325 <i>passim</i>, 31, 56 to 74, 83, 91"),
    ("2, 1.13, 1.49, 1.3 <i>illus.</i>, 1.8, 1.98, 1.2",
        "1.2, 1.3 <i>illus.</i>, 1.8, 1.13, 1.49, 1.98, 2"),
    ("2, 1.13, 1.4.12, 1.4.6, 1.4, 1.4.1, 1.8, 1.98, 1.2",
        "1.2, 1.4, 1.4.1, 1.4.6, 1.4.12, 1.8, 1.13, 1.98, 2"),
    ("3-10, <i>71-</i>2, 82-85, 87-<i>8</i>, 96-<b>117</b>, 97-9",
        """3\u201310, <i>71</i>\u201372, 82\u201385, 87\u2013<i>88</i>, \
96\u2013<b>117</b>""",),
    ("1200-1213, 1300-324, 1400-81, 1500-9",
        "1200\u20131213, 1300\u20131324, 1400\u20131481, 1500\u20131509"),
    ("100-4, 110-15, 120-8, 1100-1113, 1200-7, 1300-34, 1400-1595, \
1500-1581",
        """100\u2013104, 110\u2013115, 120\u2013128, 1100\u20131113, \
1200\u20131207, 1300\u20131334, 1400\u20131595"""),
    ("101-108, 202-15, 304-9, 808-33, 909-11, 1103-4, 1205-16, \
1308-401",
        """101\u2013108, 202\u2013215, 304\u2013309, 808\u2013833, \
909\u2013911, 1103\u20131104, 1205\u20131216, 1308\u20131401"""),
    ("321-28, 418-9, 498-532, 1087-89, 1287-9, 1496-500, 11564-615, \
12991-3001",
        """321\u2013328, 418\u2013419, 498\u2013532, 1087\u20131089, \
1287\u20131289, 1496\u20131500, 11564\u201311615, 12991\u201313001"""),
    ("101-08, 808-33, 909-21, 1103-104, 1202-206",
        "101\u2013108, 808\u2013833, 909\u2013921, 1103\u20131104, \
1202\u20131206"),
    ("101–108, 808–833, 1103–1104", "101–108, 808–833, 1103–1104"),
    ("321–328, 498–532, 1087–1089, 1496–1500, 11564–11615, 12991–13001",
        "321–328, 498–532, 1087–1089, 1496–1500, 11564–11615, 12991–13001"),
    ("89, 106–108n., Frontispiece, 202f, 14-18 passim, 21",
        "Frontispiece, 14\u201318 passim, 21, 89, 106–108n., 202f"),
    # Dissalowed
    # ("vi, xiv, 9-15, <i>illus.</i> 45",
    #  "vi, xiv, 9-15, <i>illus.</i> 45"),
    ("<b>13</b>:10:19-21, <b>20</b>:46:5, <b>21</b>:3:15",
        "<b>13</b>:10:19\u201321, <b>20</b>:46:5, <b>21</b>:3:15"),
    ("mcmlxv, mcmlxx", "mcmlxv, mcmlxx"),
    ("53(vii)A, 53(vii)B, 53(ix)A", "53(vii)A, 53(vii)B, 53(ix)A"),
    # ("18, 45-47, A-2, Plate XIV", "A-2, Plate XIV, 18, 45\u201347"),
    ("II:5, II:7-9, II:24, II:55", "II:5, II:7\u20139, II:24, II:55"),
    # ("3-10 to 3-15, 4.10-15, A-2, B-7 to B-10",
    #     "A-2, B-7 to B-10, 3-10 to 3-15, 4.10\u201315"),
    ("32-38, 40fig, 45(ph), 45(map), 45t, 75-78",
        "32\u201338, 40fig, 45t, 45(map), 45(ph), 75\u201378"),
    ("56t12, 63a-66b, IV:2.3.1(a), 2:435, Plate IV@45, Plate XI@56.1",
        "IV:2.3.1(a), 2:435, Plate IV@45, 56t12, Plate XI@56.1, \
63a\u201366b"),
    ("85(nn. 15, 18), 56(t12), 112n26, 71(nn 23, 27), 91t.13, 105n14",
        "56(t12), 71(nn 23, 27), 85(nn. 15, 18), 91t.13, 105n14, 112n26"),
    # ("STR-23, UTL-4, REF-10, STR-5, STR-24",
    #     "REF-10, STR-5, STR-23, STR-24, UTL-4"),
    )

PAGESPAIRS2 = (
    ("""89, 32, 4, xii, 492, vi, 12, xiv, 49, vi, 89, 18(nn 12, 15)""",
        """vi, xii, xiv, 4, 12, 18(nn 12, 15), 32, 49, 89, 492"""),
    ("""<b>719, 34, 11t</b>, ix, 42, <i>iv, 13f, 88</i>, 39, 4""",
        """<i>iv</i>, ix, 4, <b>11t</b>, <i>13f</i>,
<b>34</b>, 39, 42, <i>88</i>, <b>719</b>"""),
    ("""85, <b>35</b>(nn. 11, 19), 75<sub>2</sub>,\
<i>81<sup>a</sup></i>, 49""",
        """<b>35</b>(nn. 11, 19), 49, 75<sub>2</sub>,
<i>81</i><sup><i>a</i></sup>, 85"""),
    ("101–08, <b>808</b>–833, <i>1103–</i>104, 1206(nn. <b>83</b>, 91)",
        "101–8, <b>808</b>–33, <i>1103</i>–4, 1206(nn. <b>83</b>, 91)"),
    ("""<i>281f</i>, <i><span style="font-size: 11pt;
font-family: 'times new roman';">240 - 248 </span></i>, 116- 118, xv,
<b>32t</b>, 24""",
        """xv, 24, <b>32t</b>, 116\u201318, \
<i><span style="font-size: 11pt; font-family: 'times new roman';">240\
</span></i><i>\u2013</i>\
<i><span style="font-size: 11pt; font-family: 'times new roman';">48\
</span></i>, <i>281f</i>"""),
    ("102–09, <b>908</b>–933, 2103–<i>104</i>",
        "102–9, <b>908</b>–33, 2103–<i>4</i>"),
    ("321–328, 498–532, 1087–1089, 1496–1500, 11564–1615, 12991–13001",
        "321–28, 498–532, 1087–89, 1496–500, 11564–615, 12991–3001"),
    ("""89, 32, 4, xii, 492, vi, 12, <b>xiv-</b>xvii, 49, vi, 89""",
        """vi, xii, <b>xiv</b>\u2013xvii, 4, 12, 32, 49, 89, 492"""),
    ("""<b>719, 34, 11t</b>, ix, 42, <i>iv, 13f, 88</i>, 39, 4""",
        """<i>iv</i>, ix, 4, <b>11t</b>, <i>13f</i>,
<b>34</b>, 39, 42, <i>88</i>, <b>719</b>"""),
    ("""85, <b>35</b>, 75<sub>2</sub>, <i>81<sup>a</sup></i>,
49""",
        """<b>35</b>, 49, 75<sub>2</sub>,
<i>81</i><sup><i>a</i></sup>, 85"""),
    ("""<i>281f</i>, <i><span style="font-size: 11pt;
font-family: 'times new roman';">240 - 248 </span></i>, 116- 118, xv,
<b>32t</b>, 24""",
        """xv, 24, <b>32t</b>, 116\u201318, \
<i><span style="font-size: 11pt; font-family: 'times new roman';">240\
</span></i><i>\u2013</i>\
<i><span style="font-size: 11pt; font-family: 'times new roman';">48\
</span></i>, <i>281f</i>"""),
    ("""<i>203,</i> 290-293, <i>177-182,</i> <span
style="font-size: 11pt; font-family: 'arial';"><i>105,</i></span>
<i>343 - 350,</i> <i><b>239</b>,</i> 154, <span style="font-size: 11pt;
font-family: 'arial';">100,</span> 110, 63, <b>482</b>""",
        """63, <span style="font-size: 11pt; font-family:
'arial';">100</span>, <i><span style="font-size: 11pt; font-family:
'arial';">105</span></i>, 110, 154, <i>177</i><i>\u2013</i><i>82</i>, \
<i>203</i>, <i><b>239</b></i>, 290\u201393, \
<i>343</i><i>\u2013</i><i>50</i>, <b>482</b>"""),
    ("""420, 51<b>t</b>, <i>91<b>f,</b></i> 47\u2013<i>52,</i> 98,
420, 51<b>t</b>, <i>91<b>f</b>,</i> 47\u2013<i>52</i>, 98,
<b>82-<i>84</i></b>""",
        """47\u2013<i>52</i>, 51<b>t</b>,
<b>82</b><b>\u2013</b><i><b>84</b></i>, <i>91</i><i><b>f</b></i>, 98, \
420"""),
    ("""<b>117</b>, 420, 51<b>t</b>, <i>91<b>f</b></i>,
47-<i>52</i>, <b>62-</b><b><i>64</i></b>, 98, <i>2</i>""",
        """<i>2</i>, 47\u2013<i>52</i>, 51<b>t</b>,
<b>62</b><b>\u2013</b><i><b>64</b></i>, <i>91</i><i><b>f</b></i>, 98, \
<b>117</b>, 420"""),
    ("""7, 12, 78, 81<i>f</i>, 92-96, 203<b>t</b>, 206, 255,
290, 300t, 381, 482, 491, iv, xviii, <b>75c</b>""",
        """iv, xviii, 7, 12, <b>75c</b>, 78, 81<i>f</i>, 92\u201396,
203<b>t</b>, 206, 255, 290, 300t, 381, 482, 491""",),
    ("83, 56 to 74, 91, Frontispiece@0.1, 21-25 <i>passim</i>, 31",
        "Frontispiece@0.1, 21\u201325 <i>passim</i>, 31, 56 to 74, 83, 91"),
    ("2, 1.13, 1.49, 1.3 <i>illus.</i>, 1.8, 1.98, 1.2",
        "1.2, 1.3 <i>illus.</i>, 1.8, 1.13, 1.49, 1.98, 2"),
    ("2, 1.13, 1.4.12, 1.4.6, 1.4, 1.4.1, 1.8, 1.98, 1.2",
        "1.2, 1.4, 1.4.1, 1.4.6, 1.4.12, 1.8, 1.13, 1.98, 2"),
    ("3-10, <i>71-</i>2, 82-85, 87-<i>8</i>, 96-<b>117</b>, 97-9",
        """3\u201310, <i>71</i>\u201372, 82\u201385, 87\u2013<i>88</i>, \
96\u2013<b>117</b>""",),
    ("1200-1213, 1300-324, 1400-81, 1500-9",
        "1200\u20131213, 1300\u20131324, 1400\u20131481, 1500\u20131509"),
    ("100-4, 110-15, 120-8, 1100-1113, 1200-7, 1300-34, 1400-1595, \
1500-1581",
        """100\u2013104, 110\u201315, 120\u201328, 1100\u20131113, \
1200\u20131207, 1300\u20131334, 1400\u20131595"""),
    ("101-108, 202-15, 304-9, 808-33, 909-11, 1103-4, 1205-16, \
1308-401",
        """101\u20138, 202\u201315, 304\u20139, 808\u201333, \
909\u201311, 1103\u20134, 1205\u201316, 1308\u2013401"""),
    ("321-28, 418-9, 498-532, 1087-89, 1287-9, 1496-500, 11564-615, \
12991-3001",
        """321\u201328, 418\u201319, 498\u2013532, 1087\u201389, \
1287\u201389, 1496\u2013500, 11564\u2013615, 12991\u20133001"""),
    ("101-08, 808-33, 909-21, 1103-104, 1202-206",
        "101\u20138, 808\u201333, 909\u201321, 1103\u20134, 1202\u20136"),
    ("101–108, 808–833, 1103–1104",
        "101–8, 808–33, 1103–4"),
    ("321–328, 498–532, 1087–1089, 1496–1500, 11564–11615, 12991–13001",
        "321–28, 498–532, 1087–89, 1496–500, 11564–615, 12991–3001"),
    ("89, 106–108n., Frontispiece, 202f, 13-18 passim, 21",
        "Frontispiece, 13\u201318 passim, 21, 89, 106–108n., 202f"),
    # Dissalowed
    # ("vi, xiv, 9-15, <i>illus.</i> 45",
    #  "vi, xiv, 9-15, <i>illus.</i> 45"),
    ("<b>13</b>:10:19-21, <b>20</b>:46:5, <b>21</b>:3:15",
        "<b>13</b>:10:19\u201321, <b>20</b>:46:5, <b>21</b>:3:15"),
    ("mcmlxv, mcmlxx", "mcmlxv, mcmlxx"),
    ("53(vii)A, 53(vii)B, 53(ix)A", "53(vii)A, 53(vii)B, 53(ix)A"),
    # ("18, 45-47, A-2, Plate XIV", "A-2, Plate XIV, 18, 45\u201347"),
    ("II:5, II:7-9, II:24, II:55", "II:5, II:7\u20139, II:24, II:55"),
    # ("3-10 to 3-15, 4.10-15, A-2, B-7 to B-10",
    #     "A-2, B-7 to B-10, 3-10 to 3-15, 4.10\u201315"),
    ("32-38, 40fig, 45(ph), 45(map), 45t, 75-78",
        "32\u201338, 40fig, 45t, 45(map), 45(ph), 75\u201378"),
    ("56t12, 63a-66b, IV:2.3.1(a), 2:435, Plate IV@45, Plate XI@56.1",
        "IV:2.3.1(a), 2:435, Plate IV@45, 56t12, Plate XI@56.1, \
63a\u201366b"),
    ("56(t12), 71(nn 23, 27), 85(nn. 15, 18), 91t.13, 105n14, 112n26",
        "56(t12), 71(nn 23, 27), 85(nn. 15, 18), 91t.13, 105n14, 112n26"),
    # ("STR-23, UTL-4, REF-10, STR-5, STR-24",
    #     "REF-10, STR-5, STR-23, STR-24, UTL-4"),
    )

PAGESPAIRS4 = (
    ("30-31, 42-43, 132-136, 1841-1845, 10-12, 15-19, 114-118, \
214-215, 310-311",
        "10–12, 15–19, 30–1, 42–3, 114–18, 132–6, 214–15, 310–11, 1841–5"),
    )


if __name__ == "__main__":
    unittest.main()
